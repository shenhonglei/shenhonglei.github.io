<!doctype html><html lang=zh-zh><head><meta charset=utf-8><title>k8s 上部署 Metrics Server</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="Mac 系统里 docker-desktop上运行的 Kubernetes v1.19.3 上启动Metrics Server"><meta name=author content="shenhonglei"><meta name=generator content="Hugo 0.74.3"><link rel=stylesheet href=https://shenhonglei.com/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://shenhonglei.com/plugins/Ionicons/css/ionicons.min.css><link rel=stylesheet href=https://shenhonglei.com/plugins/magnific-popup/magnific-popup.css><link rel=stylesheet href=https://shenhonglei.com/plugins/slick/slick.css><link rel=stylesheet href=https://shenhonglei.com/scss/style.min.css media=screen><link rel="shortcut icon" href=https://shenhonglei.com/images/favicon.png type=image/x-icon><link rel=icon href=https://shenhonglei.com/images/favicon.png type=image/x-icon></head><body><div class=preloader></div><header class=navigation><div class=container><div class=row><div class=col-md-12><nav class=navbar><div class=navbar-header><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#navigation>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=/><img src=https://shenhonglei.com/images/logo.png alt="Honglei | Honglei's Blog" width=150px class=img-responsive></a></div><div class="collapse navbar-collapse" id=navigation><ul class="nav navbar-nav navbar-right"><li><a href=/>首页</a></li><li><a href=/blog>博客</a></li><li><a href=/csdn>CSDN</a></li><li><a href=/about>关于</a></li></ul></div></nav></div></div></div></header><section class="page-title bg-2" style=background-image:url(https://shenhonglei.com/images/featue-bg.jpg)><div class=container><div class=row><div class=col-md-12><div class=block><h1>k8s 上部署 Metrics Server</h1><p>Mac 系统里 docker-desktop上运行的 Kubernetes v1.19.3 上启动Metrics Server</p></div></div></div></div></section><section class=page-wrapper><div class=container><div class=row><div class=col-md-8><div class="post post-single"><h2 class=post-title>k8s 上部署 Metrics Server</h2><div class=post-meta><ul><li><i class=ion-calendar></i>December 15, 2020</li><li><i class=ion-android-people></i>作者
<a class=text-primary href=/author/honglei>honglei</a></li><li><i class=ion-pricetags></i><a href=/tags/k8s>K8s</a>
, <a href=/tags/%e7%9b%91%e6%8e%a7>监控</a></li></ul></div><div class=post-thumb><img class=img-responsive src=/images/csdn/csdn-kubernetes-metrics-server.png alt="k8s 上部署 Metrics Server"></div><div class="post-content post-excerpt"><h1 id=环境>环境</h1><p>Mac 系统里 docker-desktop上运行的 Kubernetes v1.19.3 上启动Metrics Server</p><h1 id=场景>场景</h1><p>资源使用指标，例如容器 CPU 和内存使用率，可通过 Metrics API 在 Kubernetes 中获得。 这些指标可以直接被用户访问，比如使用 kubectl top 命令行，或者被集群中的控制器 （例如 Horizontal Pod Autoscalers) 使用来做决策。</p><h1 id=metrics-api>Metrics API</h1><p>通过 Metrics API，你可以获得指定节点或 Pod 当前使用的资源量。 此 API 不存储指标值，因此想要获取某个指定节点 10 分钟前的 资源使用量是不可能的。</p><p>此 API 与其他 API 没有区别：</p><ul><li>此 API 和其它 Kubernetes API 一起位于同一端点（endpoint）之下且可发现， 路径为 /apis/metrics.k8s.io/</li><li>它具有相同的安全性、可扩展性和可靠性保证
Metrics API 在 k8s.io/metrics 仓库中定义。你可以在那里找到有关 Metrics API 的更多信息。</li></ul><blockquote><p>说明： Metrics API 需要在集群中部署 Metrics Server。否则它将不可用。</p></blockquote><h1 id=metrics-api-not-available>Metrics API not available</h1><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#查看node的资源使用情况</span>
➜  ~ kubectl top node
error: Metrics API not available <span style=color:#75715e>#没有部署Metrics时会报错</span>
<span style=color:#75715e>#查看</span>
➜  ~ kubectl cluster-info
Kubernetes master is running at https://kubernetes.docker.internal:6443
KubeDNS is running at https://kubernetes.docker.internal:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</code></pre></div><h1 id=k8s-上部署-metrics-server>k8s 上部署 Metrics Server</h1><h2 id=下载镜像和componentsyaml>下载镜像和components.yaml</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#需要解决科学上网才能下载镜像k8s.gcr.io/metrics-server/metrics-server:v0.4.1</span>
<span style=color:#75715e>#从csdn下载K8s metrics-server.zip</span>
<span style=color:#75715e>#解压K8s metrics-server.zip</span>
docker load -i k8s-gcr-io-metrics-server-metrics-server-v0.4.1.rar 
</code></pre></div><h2 id=查看确认镜像>查看确认镜像</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>➜  metrics-server git:<span style=color:#f92672>(</span>91dbeeb<span style=color:#f92672>)</span> docker images | grep metrics-server
k8s.gcr.io/metrics-server/metrics-server                                                                    v0.4.1                                           9759a41ccdf0   <span style=color:#ae81ff>3</span> weeks ago     60.5MB
➜  metrics-server git:<span style=color:#f92672>(</span>91dbeeb<span style=color:#f92672>)</span> cd /
</code></pre></div><h2 id=k8s启动metrics-server>k8s启动metrics-server</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#本地执行，根据自己的components.yaml目录来执行</span>
kubectl apply -f components.yaml
</code></pre></div><h2 id=运行记录>运行记录</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>➜  metrics-server git:<span style=color:#f92672>(</span>91dbeeb<span style=color:#f92672>)</span> kubectl apply -f components.yaml
serviceaccount/metrics-server created
clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created
clusterrole.rbac.authorization.k8s.io/system:metrics-server created
rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created
clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created
clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created
service/metrics-server created
deployment.apps/metrics-server created
apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created
</code></pre></div><h2 id=验证metrics-server>验证metrics-server</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>➜  Desktop kubectl top nodes
NAME             CPU<span style=color:#f92672>(</span>cores<span style=color:#f92672>)</span>   CPU%   MEMORY<span style=color:#f92672>(</span>bytes<span style=color:#f92672>)</span>   MEMORY%
docker-desktop   308m         7%     1794Mi          37%
</code></pre></div><h1 id=注意事项-x509-cannot-validate-certificate>注意事项 x509: cannot validate certificate</h1><p>默认从官方拉取的文件</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
</code></pre></div><p>在mac的docker desktop 上运行会出现如下问题 x509: cannot validate certificate</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>➜  Desktop kubectl logs metrics-server-866b7d5b74-bml25 -n kube-system
E1214 06:55:09.483690       <span style=color:#ae81ff>1</span> server.go:132<span style=color:#f92672>]</span> unable to fully scrape metrics: unable to fully scrape metrics from node docker-desktop: unable to fetch metrics from node docker-desktop: Get <span style=color:#e6db74>&#34;https://192.168.65.3:10250/stats/summary?only_cpu_and_memory=true&#34;</span>: x509: cannot validate certificate <span style=color:#66d9ef>for</span> 192.168.65.3 because it doesn<span style=color:#960050;background-color:#1e0010>&#39;</span>t contain any IP SANs
I1214 06:55:09.501441       <span style=color:#ae81ff>1</span> requestheader_controller.go:169<span style=color:#f92672>]</span> Starting RequestHeaderAuthRequestController
I1214 06:55:09.501637       <span style=color:#ae81ff>1</span> configmap_cafile_content.go:202<span style=color:#f92672>]</span> Starting client-ca::kube-system::extension-apiserver-authentication::client-ca-file
I1214 06:55:09.501976       <span style=color:#ae81ff>1</span> shared_informer.go:240<span style=color:#f92672>]</span> Waiting <span style=color:#66d9ef>for</span> caches to sync <span style=color:#66d9ef>for</span> client-ca::kube-system::extension-apiserver-authentication::client-ca-file
I1214 06:55:09.501795       <span style=color:#ae81ff>1</span> shared_informer.go:240<span style=color:#f92672>]</span> Waiting <span style=color:#66d9ef>for</span> caches to sync <span style=color:#66d9ef>for</span> RequestHeaderAuthRequestController
I1214 06:55:09.502403       <span style=color:#ae81ff>1</span> secure_serving.go:197<span style=color:#f92672>]</span> Serving securely on <span style=color:#f92672>[</span>::<span style=color:#f92672>]</span>:4443
I1214 06:55:09.502482       <span style=color:#ae81ff>1</span> dynamic_serving_content.go:130<span style=color:#f92672>]</span> Starting serving-cert::/tmp/apiserver.crt::/tmp/apiserver.key
I1214 06:55:09.502740       <span style=color:#ae81ff>1</span> tlsconfig.go:240<span style=color:#f92672>]</span> Starting DynamicServingCertificateController
I1214 06:55:09.503168       <span style=color:#ae81ff>1</span> configmap_cafile_content.go:202<span style=color:#f92672>]</span> Starting client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file
I1214 06:55:09.503275       <span style=color:#ae81ff>1</span> shared_informer.go:240<span style=color:#f92672>]</span> Waiting <span style=color:#66d9ef>for</span> caches to sync <span style=color:#66d9ef>for</span> client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file
I1214 06:55:09.602354       <span style=color:#ae81ff>1</span> shared_informer.go:247<span style=color:#f92672>]</span> Caches are synced <span style=color:#66d9ef>for</span> RequestHeaderAuthRequestController
I1214 06:55:09.602454       <span style=color:#ae81ff>1</span> shared_informer.go:247<span style=color:#f92672>]</span> Caches are synced <span style=color:#66d9ef>for</span> client-ca::kube-system::extension-apiserver-authentication::client-ca-file
I1214 06:55:09.603660       <span style=color:#ae81ff>1</span> shared_informer.go:247<span style=color:#f92672>]</span> Caches are synced <span style=color:#66d9ef>for</span> client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file
I1214 06:55:38.519063       <span style=color:#ae81ff>1</span> configmap_cafile_content.go:223<span style=color:#f92672>]</span> Shutting down client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file
I1214 06:55:38.519300       <span style=color:#ae81ff>1</span> configmap_cafile_content.go:223<span style=color:#f92672>]</span> Shutting down client-ca::kube-system::extension-apiserver-authentication::client-ca-file
I1214 06:55:38.519340       <span style=color:#ae81ff>1</span> requestheader_controller.go:183<span style=color:#f92672>]</span> Shutting down RequestHeaderAuthRequestController
I1214 06:55:38.519547       <span style=color:#ae81ff>1</span> tlsconfig.go:255<span style=color:#f92672>]</span> Shutting down DynamicServingCertificateController
I1214 06:55:38.519553       <span style=color:#ae81ff>1</span> dynamic_serving_content.go:145<span style=color:#f92672>]</span> Shutting down serving-cert::/tmp/apiserver.crt::/tmp/apiserver.key
I1214 06:55:38.519819       <span style=color:#ae81ff>1</span> secure_serving.go:241<span style=color:#f92672>]</span> Stopped listening on <span style=color:#f92672>[</span>::<span style=color:#f92672>]</span>:4443
</code></pre></div><h2 id=解决办法>解决办法</h2><p><a href=https://github.com/kubernetes-sigs/metrics-server/issues/637>根据官方的github issues</a>
添加一行- &ndash;kubelet-insecure-tls</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  <span style=color:#66d9ef>template</span>:
    <span style=color:#66d9ef>metadata</span>:
      <span style=color:#66d9ef>labels</span>:
        <span style=color:#66d9ef>k8s-app</span>: metrics-server
    <span style=color:#66d9ef>spec</span>:
      <span style=color:#66d9ef>containers</span>:
      - <span style=color:#66d9ef>args</span>:
        - --cert-dir=/tmp
        - --secure-port=<span style=color:#ae81ff>4443</span>
        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
        - --kubelet-use-node-status-port
        - --kubelet-insecure-tls
        <span style=color:#66d9ef>image</span>: k8s.gcr.io/metrics-server/metrics-server:v0<span style=color:#ae81ff>.4.1</span>
</code></pre></div><h1 id=下载资源>下载资源</h1><p><a href=https://download.csdn.net/download/shenhonglei1234/13686143>资源下载地址</a></p></div><div class=post-comments><div id=gitalk-container></div><link rel=stylesheet href=https://unpkg.com/gitalk/dist/gitalk.css><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script><script>const gitalk=new Gitalk({clientID:'e888637db32e8bd4431b',clientSecret:'1118f7d74f6dff42af59655e7cd32da20d3621e5',repo:'shenhonglei\/shenhonglei.github.io',owner:'shenhonglei',admin:['shenhonglei'],id:location.pathname,distractionFreeMode:false});(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('gitalk-container').innerHTML='Gitalk comments not available by default when the website is previewed locally.';return;}
gitalk.render('gitalk-container');})();</script></div></div></div><div class=col-md-4><aside class=sidebar><div class="widget widget-latest-post"><h4 class=widget-title>最新内容</h4><div class=media><a class=pull-left href=https://shenhonglei.com/csdn/kubernetes-metrics-server/><img class=media-object src=/images/csdn/csdn-kubernetes-metrics-server.png alt="k8s 上部署 Metrics Server"></a><div class=media-body><h4 class=media-heading><a href=https://shenhonglei.com/csdn/kubernetes-metrics-server/>k8s 上部署 Metrics Server</a></h4><p>环境 Mac 系统里 docker-desktop上运行的 Kubernetes v1.19.3 上 …</p></div></div><div class=media><a class=pull-left href=https://shenhonglei.com/csdn/selinux/><img class=media-object src=/images/csdn/csdn-selinux.png alt=SELinux|Disabled、Permissive、Enforcing></a><div class=media-body><h4 class=media-heading><a href=https://shenhonglei.com/csdn/selinux/>SELinux|Disabled、Permissive、Enforcing</a></h4><p>SELinux是什么 SELinux，Security Enhanced Linux 的缩写，也就是 …</p></div></div><div class=media><a class=pull-left href=https://shenhonglei.com/blog/blog-post-1/><img class=media-object src=/images/blog/blog-post-1.jpg alt="How To Wear Bright Shoes"></a><div class=media-body><h4 class=media-heading><a href=https://shenhonglei.com/blog/blog-post-1/>How To Wear Bright Shoes</a></h4><p>Lorem ipsum dolor sit amet, consectetur …</p></div></div><div class=media><a class=pull-left href=https://shenhonglei.com/blog/blog-post-2/><img class=media-object src=/images/blog/blog-post-2.jpg alt="How To Wear Bright Shoes"></a><div class=media-body><h4 class=media-heading><a href=https://shenhonglei.com/blog/blog-post-2/>How To Wear Bright Shoes</a></h4><p>Lorem ipsum dolor sit amet, consectetur …</p></div></div></div><div class="widget widget-category"><h4 class=widget-title>目录</h4><ul class=widget-category-list><li><a href=/categories/artificial-intelligence>Artificial intelligence</a></li><li><a href=/categories/company-news>Company news</a></li><li><a href=/categories/kubernetes>Kubernetes</a></li><li><a href=/categories/legacy-support>Legacy support</a></li><li><a href=/categories/linux>Linux</a></li></ul></div><div class="widget widget-tag"><h4 class=widget-title>标签</h4><ul class=widget-tag-list><li><a href=/tags/advice>Advice</a></li><li><a href=/tags/ai>Ai</a></li><li><a href=/tags/android>Android</a></li><li><a href=/tags/company>Company</a></li><li><a href=/tags/k8s>K8s</a></li><li><a href=/tags/mechine>Mechine</a></li><li><a href=/tags/news>News</a></li><li><a href=/tags/retro>Retro</a></li><li><a href=/tags/selinux>Selinux</a></li><li><a href=/tags/technology>Technology</a></li><li><a href=/tags/%e7%9b%91%e6%8e%a7>监控</a></li></ul></div></aside></div></div></div></section><footer class=footer><div class=container><div class=row><div class=col-md-12><div class=footer-manu><ul></ul></div><p class=copyright>Copyright © 2020 <a href=https://shenhonglei.com>申红磊</a> All Rights Reserved</p></div></div></div></footer><script src=https://shenhonglei.com/plugins/jQuery/jquery.min.js></script><script src=https://shenhonglei.com/plugins/bootstrap/bootstrap.min.js></script><script src=https://shenhonglei.com/plugins/slick/slick.min.js></script><script src=https://shenhonglei.com/plugins/magnific-popup/jquery.magnific-popup.min.js></script><script src=https://shenhonglei.com/plugins/shuffle/shuffle.min.js></script><script src=https://shenhonglei.com/plugins/google-map/gmap.js></script><script src=https://shenhonglei.com/js/script.min.js></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-181030130-1','auto');ga('send','pageview');</script></body></html>